<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rollplaying: d6 Dice Pool Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #6366f1; --secondary: #f97316; --bg: #f1f5f9; --card: #ffffff; }
        body { font-family: system-ui, sans-serif; margin: 0; padding: 10px; background: var(--bg); color: #1e293b; }
        .app-container { background: var(--card); width: 100%; max-width: 420px; padding: 15px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin: auto; }
        
        .tabs { display: flex; background: #f1f5f9; padding: 3px; border-radius: 10px; margin-bottom: 12px; }
        .tab { flex: 1; padding: 8px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8rem; background: transparent; color: #64748b; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .mode-toggle { display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 12px; }
        .toggle-btn { flex: 1; padding: 6px; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; background: white; font-size: 0.7rem; font-weight: bold; color: #64748b; }
        .toggle-btn.active { border-color: var(--primary); color: var(--primary); background: #eef2ff; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        label { font-size: 0.65rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; display: block; }
        
        .stepper { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 2px; }
        .step-btn { width: 34px; height: 34px; border-radius: 6px; border: none; background: white; color: var(--primary); font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .step-value { font-size: 1rem; font-weight: 700; width: 40px; text-align: center; }

        .chart-wrapper { height: 180px; margin-bottom: 12px; }
        
        .table-container { border: 1px solid #e2e8f0; border-radius: 10px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { background: #f8fafc; padding: 6px; border-bottom: 1px solid #e2e8f0; }
        td { padding: 6px; border-bottom: 1px solid #f1f5f9; text-align: center; cursor: pointer; transition: background 0.2s; position: relative; }
        
        /* Subtle Selection Style */
        tr.selected { background-color: #f5f7ff; }
        tr.selected td:first-child { border-left: 4px solid var(--primary); }

        .diff-box { margin-top: 15px; padding: 12px; background: #f8fafc; border-radius: 12px; border: 1px dashed #cbd5e1; text-align: center; }
        .diff-text { font-size: 0.8rem; font-weight: 600; color: #64748b; }
        .diff-val { font-size: 1.1rem; font-weight: 800; color: var(--primary); display: block; margin-top: 2px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="tabs">
        <button class="tab active" onclick="setTab('single')">Single Pool</button>
        <button class="tab" onclick="setTab('range')">Pool Range</button>
    </div>

    <div class="mode-toggle">
        <button id="modeOver" class="toggle-btn active" onclick="setMode('over')">Roll Over (X+)</button>
        <button id="modeUnder" class="toggle-btn" onclick="setMode('under')">Roll Under (X-)</button>
    </div>

    <div class="controls">
        <div><label>On Die</label><div class="stepper">
            <button class="step-btn" onclick="updateVal('dieTarget', -1)">−</button>
            <div class="step-value" id="dieTargetVal">5+</div>
            <button class="step-btn" onclick="updateVal('dieTarget', 1)">+</button>
        </div></div>
        <div><label id="secondaryLabel">Dice</label><div class="stepper">
            <button class="step-btn" onclick="updateVal('secondary', -1)">−</button>
            <div class="step-value" id="secondaryVal">5</div>
            <button class="step-btn" onclick="updateVal('secondary', 1)">+</button>
        </div></div>
    </div>

    <div class="chart-wrapper"><canvas id="mainChart"></canvas></div>

    <div class="table-container">
        <table>
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="diff-box">
        <span class="diff-text" id="diffLabel">Tap two rows to compare</span>
        <span class="diff-val" id="diffResult">--%</span>
    </div>
</div>

<script>
    let currentTab = 'single', currentMode = 'over', dieTarget = 5, secondaryVal = 5, myChart;
    let selectedRows = [];

    function combinations(n, k) {
        if (k < 0 || k > n) return 0;
        let res = 1;
        for (let i = 1; i <= k; i++) res = res * (n - i + 1) / i;
        return res;
    }

    function setTab(tab) {
        currentTab = tab;
        selectedRows = [];
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', (i === 0 && tab === 'single') || (i === 1 && tab === 'range')));
        document.getElementById('secondaryLabel').innerText = tab === 'single' ? 'Dice' : 'Hits Req';
        calculate();
    }

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('modeOver').classList.toggle('active', mode === 'over');
        document.getElementById('modeUnder').classList.toggle('active', mode === 'under');
        calculate();
    }

    function updateVal(type, change) {
        if (type === 'dieTarget') dieTarget = Math.min(6, Math.max(2, dieTarget + change));
        else secondaryVal = Math.min(10, Math.max(1, secondaryVal + change));
        calculate();
    }

    function selectRow(index, value) {
        const rows = document.getElementById('tableBody').rows;
        const existing = selectedRows.find(r => r.index === index);
        
        if (existing) {
            selectedRows = selectedRows.filter(r => r.index !== index);
            rows[index].classList.remove('selected');
        } else {
            if (selectedRows.length >= 2) {
                rows[selectedRows[0].index].classList.remove('selected');
                selectedRows.shift();
            }
            selectedRows.push({index, value});
            rows[index].classList.add('selected');
        }
        updateDifference();
    }

    function updateDifference() {
        const label = document.getElementById('diffLabel');
        const res = document.getElementById('diffResult');
        if (selectedRows.length === 2) {
            const diff = Math.abs(selectedRows[0].value - selectedRows[1].value).toFixed(1);
            label.innerText = `Probability Gap:`;
            res.innerText = `${diff}%`;
        } else {
            label.innerText = "Tap two rows to compare";
            res.innerText = "--%";
        }
    }

    function calculate() {
        const p = currentMode === 'over' ? (7 - dieTarget) / 6 : dieTarget / 6;
        const labels = [], exactData = [], cumulativeData = [], tbody = document.getElementById('tableBody'), thead = document.getElementById('tableHead');
        tbody.innerHTML = '';
        document.getElementById('dieTargetVal').innerText = dieTarget + (currentMode === 'over' ? '+' : '-');
        document.getElementById('secondaryVal').innerText = secondaryVal;

        if (currentTab === 'single') {
            thead.innerHTML = '<tr><th>Hits</th><th>Exact</th><th>At Least</th></tr>';
            let exactProbs = [];
            for (let k = 0; k <= secondaryVal; k++) {
                exactProbs.push(combinations(secondaryVal, k) * Math.pow(p, k) * Math.pow(1 - p, secondaryVal - k));
            }
            for (let k = 0; k <= secondaryVal; k++) {
                labels.push(k);
                const e = (exactProbs[k] * 100).toFixed(1), c = (exactProbs.slice(k).reduce((a, b) => a + b, 0) * 100).toFixed(1);
                exactData.push(e); cumulativeData.push(c);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${k}</td><td>${e}%</td><td>${c}%</td>`;
                tr.onclick = () => selectRow(k, parseFloat(c));
                tbody.appendChild(tr);
            }
            renderChart(labels, [{type:'bar', data:exactData, color:'rgba(99, 102, 241, 0.4)', label: 'Exact'}, {type:'line', data:cumulativeData, color:'#f97316', label: 'At Least'}]);
        } else {
            thead.innerHTML = '<tr><th>Pool Size</th><th>Prob of Success</th></tr>';
            for (let n = 1; n <= 10; n++) {
                labels.push(n + 'd');
                let probSum = 0;
                for (let k = secondaryVal; k <= n; k++) probSum += combinations(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
                const pct = (probSum * 100).toFixed(1);
                cumulativeData.push(pct);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${n} Dice</td><td>${pct}%</td>`;
                tr.onclick = () => selectRow(n-1, parseFloat(pct));
                tbody.appendChild(tr);
            }
            renderChart(labels, [{type:'line', data:cumulativeData, color:'#6366f1', label: 'Success'}]);
        }
        updateDifference();
    }

    function renderChart(labels, datasets) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            data: { labels: labels, datasets: datasets.map(d => ({ type: d.type, label: d.label, data: d.data, borderColor: d.color, backgroundColor: d.color, borderWidth: 2, pointRadius: 3, tension: 0.3 })) },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, max: 100, ticks: { stepSize: 25, callback: v => v + '%' } } }, plugins: { legend: { display: true, position: 'top', labels: { boxWidth: 8, font: { size: 9 } } } } }
        });
    }
    calculate();
</script>
</body>
</html>
